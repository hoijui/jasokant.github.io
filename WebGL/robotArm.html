<!DOCTYPE html>
<html lang="en">
    <head>
        <title>three.js webgl - loaders - OBJ loader</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <style>
            body {
                font-family: Monospace;
                background-color: #000;
                color: #fff;
                margin: 0px;
                overflow: hidden;
            }
            #info {
                color: #fff;
                position: absolute;
                top: 10px;
                width: 100%;
                text-align: center;
                z-index: 100;
                display:block;
            }
            #info a, .button { color: #f00; font-weight: bold; text-decoration: underline; cursor: pointer }
        </style>
    </head>
    
    <body>
        <div id="info">
            <a href="http://threejs.org" target="_blank">three.js</a> - Robot Arm Test
        </div>
        <div id="angles">
            <ul class='angles-list'>
            </ul>
        </div>
        
        <script src="js/three.min.js"></script>
        <script src="js/OBJLoader.js"></script>
        
        <script src="js/Detector.js"></script>
        <script src="js/KeyboardState.js"></script>
        <script src="js/jquery.min.js"></script>
        <script>
            
            var keyboard = new THREEx.KeyboardState();
            var robot = {};
            // Rotate an object around an arbitrary axis in object space
            var rotObjectMatrix;
            function rotateAroundObjectAxis(object, axis, radians) {
                rotObjectMatrix = new THREE.Matrix4();
                rotObjectMatrix.makeRotationAxis(axis.normalize(), radians);
                
                // old code for Three.JS pre r54:
                // object.matrix.multiplySelf(rotObjectMatrix);      // post-multiply
                // new code for Three.JS r55+:
                object.matrix.multiply(rotObjectMatrix);
                
                // old code for Three.js pre r49:
                // object.rotation.getRotationFromMatrix(object.matrix, object.scale);
                // new code for Three.js r50+:
                
                
                //object.rotation.setEulerFromRotationMatrix(object.matrix);
                object.rotation.setFromRotationMatrix(object.matrix);
            }
            
            var rotWorldMatrix;
            // Rotate an object around an arbitrary axis in world space       
            function rotateAroundWorldAxis(object, axis, radians) {
                rotWorldMatrix = new THREE.Matrix4();
                rotWorldMatrix.makeRotationAxis(axis.normalize(), radians);
                
                // old code for Three.JS pre r54:
                //  rotWorldMatrix.multiply(object.matrix);
                // new code for Three.JS r55+:
                rotWorldMatrix.multiply(object.matrix);                // pre-multiply
                
                object.matrix = rotWorldMatrix;
                
                // old code for Three.js pre r49:
                // object.rotation.getRotationFromMatrix(object.matrix, object.scale);
                // old code for Three.js pre r59:
                // object.rotation.setEulerFromRotationMatrix(object.matrix);
                // code for r59+:
                object.rotation.setFromRotationMatrix(object.matrix);
            }
            
            var container;
            
            var camera, scene, renderer;
            
            var mouseX = 0, mouseY = 0;
            
            var windowHalfX = window.innerWidth / 2;
            var windowHalfY = window.innerHeight / 2;
            
            
            init();
            animate();
            
            
            function init() {
                
                container = document.createElement( 'div' );
                document.body.appendChild( container );
                camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 2000 );
                camera.position.set(900,900,900);
                camera.up = new THREE.Vector3(0,0,1);
                camera.lookAt(new THREE.Vector3(0,0,0));
                
                //rotateAroundWorldAxis(camera,new THREE.Vector3(0,0,1),3.14);
                camera.up = new THREE.Vector3(0,0,1);
                camera.lookAt(new THREE.Vector3(0,0,0));
                
                scene = new THREE.Scene();
                
                var ambient = new THREE.AmbientLight( 0x121033 );
                scene.add( ambient );
                
                var directionalLight = new THREE.DirectionalLight( 0xffeedd );
                directionalLight.position.set( 0, 0, -1 );
                scene.add( directionalLight );
                
                
                var axisHelper = new THREE.AxisHelper(10000);
                scene.add(axisHelper);
                
                //create geometries
                robot.base = new THREE.Mesh(new THREE.CylinderGeometry(50,50,10,30,1,false), new THREE.MeshBasicMaterial({color: 0xff0003}));
                robot.stand = new THREE.Mesh(new THREE.CubeGeometry(20,80,20,20,20,20));
                robot.joint2 = new THREE.Mesh(new THREE.CylinderGeometry(15,15,15,20,1,false));
                robot.link2 = new THREE.Mesh(new THREE.CubeGeometry(20,80,20,20,20,20));
                robot.joint3 = new THREE.Mesh(new THREE.CylinderGeometry(15,15,15,20,1,false));
                robot.link3 = new THREE.Mesh(new THREE.CubeGeometry(20,80,20,20,20,20));
                robot.joint4 = new THREE.Mesh(new THREE.CylinderGeometry(15,15,15,20,1,false));
                robot.link4 = new THREE.Mesh(new THREE.CubeGeometry(20,80,20,20,20,20));
                robot.joint5 = new THREE.Mesh(new THREE.CylinderGeometry(15,15,15,20,1,false));
                robot.link5 = new THREE.Mesh(new THREE.CubeGeometry(20,80,20,20,20,20));
                robot.joint6 = new THREE.Mesh(new THREE.CylinderGeometry(15,15,15,20,1,false));
                robot.link6 = new THREE.Mesh(new THREE.CubeGeometry(20,80,20,20,20,20));
                
                //set positions
                robot.base.position.set(0,0,2);
                robot.stand.position.set(0,52,0);
                robot.joint2.position.set(0,52,0);
                robot.link2.position.set(0,0,-52);
                robot.joint3.position.set(0,-52,0);
                robot.link3.position.set(0,0,52);
                robot.joint4.position.set(0,52,0);
                robot.link4.position.set(0,0,-52);
                robot.joint5.position.set(0,-52,0);
                robot.link5.position.set(0,0,52);
                robot.joint6.position.set(0,52,0);
                robot.link6.position.set(0,0,-52);
                
                //specify parent-child relationships
                robot.joint6.add(robot.link6);
                robot.link5.add(robot.joint6);
                robot.joint5.add(robot.link5);
                robot.link4.add(robot.joint5);
                robot.joint4.add(robot.link4);
                robot.link3.add(robot.joint4);
                robot.joint3.add(robot.link3);
                robot.link2.add(robot.joint3);
                robot.joint2.add(robot.link2);
                robot.stand.add(robot.joint2);
                robot.base.add(robot.stand);
                
                robot.currentJointAngles = [0,0,0,0,0,0];
                robot.newJointAngles = [];
                
                robot.pristine = true;
                
                rotateAroundWorldAxis(robot.link6, new THREE.Vector3(1,0,0),Math.PI/2);
                rotateAroundWorldAxis(robot.joint6, new THREE.Vector3(1,0,0),Math.PI/2);
                rotateAroundWorldAxis(robot.link5, new THREE.Vector3(1,0,0),Math.PI/2);
                rotateAroundWorldAxis(robot.joint5, new THREE.Vector3(1,0,0),Math.PI/2);
                rotateAroundWorldAxis(robot.link4, new THREE.Vector3(1,0,0),Math.PI/2);
                rotateAroundWorldAxis(robot.joint4, new THREE.Vector3(1,0,0),Math.PI/2);
                rotateAroundWorldAxis(robot.link3, new THREE.Vector3(1,0,0),Math.PI/2);
                rotateAroundWorldAxis(robot.joint3, new THREE.Vector3(1,0,0),Math.PI/2);
                rotateAroundWorldAxis(robot.link2, new THREE.Vector3(1,0,0),Math.PI/2);
                rotateAroundWorldAxis(robot.joint2, new THREE.Vector3(1,0,0),Math.PI/2);
                rotateAroundWorldAxis(robot.base,new THREE.Vector3(1,0,0),Math.PI/2);
                scene.add(robot.base);
                
                
                renderer = new THREE.WebGLRenderer();
                renderer.setSize( window.innerWidth, window.innerHeight );
                container.appendChild( renderer.domElement );
                
                document.addEventListener( 'mousemove', onDocumentMouseMove, false );
                
                //
                
                window.addEventListener( 'resize', onWindowResize, false );
                
            }
            
            function onWindowResize() {
                
                windowHalfX = window.innerWidth / 2;
                windowHalfY = window.innerHeight / 2;
                
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                
                renderer.setSize( window.innerWidth, window.innerHeight );
                
            }
            
            function onDocumentMouseMove( event ) {
                
                mouseX = ( event.clientX - windowHalfX ) / 2;
                mouseY = ( event.clientY - windowHalfY ) / 2;
                
            }
            
            //
            
            function animate() {
                
                requestAnimationFrame( animate );
                checkRotation();
                render();
                
            }
            function isNumber(n){
                return typeof n == 'number' && !isNaN(n) && isFinite(n);
            }
            function checkRotation(){
                var rotSpeed = 0.1;
                var x = camera.position.x,
                    y = camera.position.y,
                    z = camera.position.z;
                
                if (keyboard.pressed("left")){ 
                    camera.position.x = x * Math.cos(rotSpeed) + y * Math.sin(rotSpeed);
                    camera.position.y = y * Math.cos(rotSpeed) - x * Math.sin(rotSpeed);
                } else if (keyboard.pressed("right")){
                    camera.position.x = x * Math.cos(rotSpeed) - y * Math.sin(rotSpeed);
                    camera.position.y = y * Math.cos(rotSpeed) + x * Math.sin(rotSpeed);
                } else if (keyboard.pressed("up")){
                    camera.position.y = y * Math.cos(rotSpeed) + z * Math.sin(rotSpeed);
                    camera.position.z = z * Math.cos(rotSpeed) - y * Math.sin(rotSpeed);
                } else if (keyboard.pressed("down")){
                    camera.position.x = x * Math.cos(rotSpeed) - z * Math.sin(rotSpeed);
                    camera.position.z = z * Math.cos(rotSpeed) + x * Math.sin(rotSpeed);
                } else if (keyboard.pressed("1+w")){
                    $.get("http://avogadro.beowulf.uwo.ca:8080/rosbridge/device/write/testDevice/joint1/" + (robot.currentJointAngles[0] + 0.1));
                } else if (keyboard.pressed("1+s")){
                    $.get("http://avogadro.beowulf.uwo.ca:8080/rosbridge/device/write/testDevice/joint1/" + (robot.currentJointAngles[0] - 0.1));
                } else if (keyboard.pressed("2+w")){
                    $.get("http://avogadro.beowulf.uwo.ca:8080/rosbridge/device/write/testDevice/joint2/" + (robot.currentJointAngles[1] + 0.1));
                } else if (keyboard.pressed("2+s")){
                    $.get("http://avogadro.beowulf.uwo.ca:8080/rosbridge/device/write/testDevice/joint2/" + (robot.currentJointAngles[1] - 0.1));
                } else if (keyboard.pressed("3+w")){
                    $.get("http://avogadro.beowulf.uwo.ca:8080/rosbridge/device/write/testDevice/joint3/" + (robot.currentJointAngles[2] + 0.1));
                } else if (keyboard.pressed("3+s")){
                    $.get("http://avogadro.beowulf.uwo.ca:8080/rosbridge/device/write/testDevice/joint3/" + (robot.currentJointAngles[2] - 0.1));
                } else if (keyboard.pressed("4+w")){
                    $.get("http://avogadro.beowulf.uwo.ca:8080/rosbridge/device/write/testDevice/joint4/" + (robot.currentJointAngles[3] + 0.1));
                } else if (keyboard.pressed("4+s")){
                    $.get("http://avogadro.beowulf.uwo.ca:8080/rosbridge/device/write/testDevice/joint4/" + (robot.currentJointAngles[3] - 0.1));
                } else if (keyboard.pressed("5+w")){
                    $.get("http://avogadro.beowulf.uwo.ca:8080/rosbridge/device/write/testDevice/joint5/" + (robot.currentJointAngles[4] + 0.1));
                } else if (keyboard.pressed("5+s")){
                    $.get("http://avogadro.beowulf.uwo.ca:8080/rosbridge/device/write/testDevice/joint5/" + (robot.currentJointAngles[4] - 0.1));
                } else if (keyboard.pressed("6+w")){
                    $.get("http://avogadro.beowulf.uwo.ca:8080/rosbridge/device/write/testDevice/joint6/" + (robot.currentJointAngles[5] + 0.1));
                } else if (keyboard.pressed("6+s")){
                    $.get("http://avogadro.beowulf.uwo.ca:8080/rosbridge/device/write/testDevice/joint6/" + (robot.currentJointAngles[5] - 0.1));
                }
                
                camera.lookAt(scene.position);
                
            } 
            
            
            function getCorrectedAngle(angle)
            {
                var correctedAngle = angle % (2*Math.PI);;
                if(correctedAngle < 0 && correctedAngle > -0.00001)
                {
                    correctedAngle=+0.0000;
                }
                correctedAngle = correctedAngle.toFixed(4);
                
                return correctedAngle;
            }
            
            function getAnglesSuccess(data)
            {
                var items = [];
                
                if(robot.pristine)
                {
                    $.each(data, function(key, val){
                        robot.newJointAngles.push(val);
                        var correctedAngle = getCorrectedAngle(val);
                        items.push( "<li id='" + key + "'>" + key + ": " + correctedAngle + "</li>" );
                    });
                    robot.pristine = false;
                }
                else
                {
                    robot.currentJointAngles = robot.newJointAngles;
                    robot.newJointAngles = [];
                    
                    $.each(data, function(key, val){
                        robot.newJointAngles.push(val);
                        var correctedAngle = getCorrectedAngle(val);
                        items.push( "<li id='" + key + "'>" + key + ": " + correctedAngle + "</li>" );
                    });
                }
                
                var joint1AngleDiff = robot.newJointAngles[0] - robot.currentJointAngles[0];
                //if(joint1AngleDiff !== 0)
                //{
                    rotateAroundWorldAxis(robot.base,new THREE.Vector3(0,0,1),joint1AngleDiff);
                //}
                var joint2AngleDiff = robot.newJointAngles[1] - robot.currentJointAngles[1];
                //if(joint2AngleDiff !== 0)
                //{
                    rotateAroundObjectAxis(robot.joint2,new THREE.Vector3(0,-1,0),joint2AngleDiff);
                //}
                
                
                var joint3AngleDiff = robot.newJointAngles[2] - robot.currentJointAngles[2];
                //if(joint3AngleDiff !== 0)
                //{
                    rotateAroundObjectAxis(robot.joint3,new THREE.Vector3(0,1,0),joint3AngleDiff);
                //}
                
                var joint4AngleDiff = robot.newJointAngles[3] - robot.currentJointAngles[3];
                //if(joint4AngleDiff !== 0)
                //{
                    rotateAroundObjectAxis(robot.joint4,new THREE.Vector4(0,1,0),joint4AngleDiff);
                //}
                
                var joint5AngleDiff = robot.newJointAngles[4] - robot.currentJointAngles[4];
                //if(joint5AngleDiff !== 0)
                //{
                    rotateAroundObjectAxis(robot.joint5,new THREE.Vector3(0,1,0),joint5AngleDiff);
                //}
                
                var joint6AngleDiff = robot.newJointAngles[5] - robot.currentJointAngles[5];
                //if(joint6AngleDiff !== 0)
                //{
                    rotateAroundObjectAxis(robot.joint6,new THREE.Vector3(0,1,0),joint6AngleDiff);
                //}
                
                
              
                
                
                
                var list = $( "<ul/>", {
                    "class": "angles-list",
                    html: items.join( "" )
                });
                
                $('.angles-list').replaceWith(list);
                
                renderer.render( scene, camera );
            }
            
            
            var counter = 1;
            
            function getPretendData()
            {
                counter++
                if(counter < 100)
                {
                var rotSpeed = 0.001;
                
                robot.currentJointAngles[0] += rotSpeed;
                robot.currentJointAngles[1] += rotSpeed;
                robot.currentJointAngles[2] += rotSpeed;
                }
                var data = {
                    "joint1": robot.currentJointAngles[0],
                    "joint2": robot.currentJointAngles[1],
                    "joint3": robot.currentJointAngles[2],
                    "joint4": 0,
                    "joint5": 0,
                    "joint6": 0
                }
                
                
                return data;
            }
            
            function ajaxSuccess(data)
            {
                var correctlyOrderedData = {
                        "joint1": data.joint1,
                        "joint2": data.joint2,
                        "joint3": data.joint3,
                        "joint4": data.joint4,
                        "joint5": data.joint5,
                        "joint6": data.joint6,
                        "joint7": data.joint7,
                        "joint8": data.joint8
                }
                getAnglesSuccess(correctlyOrderedData);
            }
            
            function render() 
            {
                
                $.getJSON("http://avogadro.beowulf.uwo.ca:8080/rosbridge/device/read/testDevice",ajaxSuccess);
                
                /*$.ajax({
                  dataType: "jsonp",
                  url: "http://avogadro.beowulf.uwo.ca:8080/rosbridge/device/read/testDevice",
                  data: data,
                  success: ajaxSuccess
                });*/
                
                /*var data = 
                {
                    "joint1": 0,
                    "joint2": 0,
                    "joint3": 0,
                    "joint4": 0,
                    "joint5": 0,
                    "joint6": 0
                }; 
                getAnglesSuccess(data);*/
                
               // getAnglesSuccess(getPretendData());
            }
            
        </script>
        
    </body>
</html>
